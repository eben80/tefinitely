<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Language Conversation Practice</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
#controls { margin-bottom: 10px; }
#chat { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.user { text-align: right; color: blue; margin: 5px; }
.assistant { text-align: left; color: green; margin: 5px; }
.suggestion { text-align: left; color: gray; font-style: italic; margin: 3px; }
input[type=text] { flex: 1; padding: 5px; font-size: 1em; }
button { padding: 5px 10px; font-size: 1em; margin-left: 5px; }
#input-area { display: flex; }
#speed-container { margin-top: 5px; }
</style>
</head>
<body>

<h1>Language Conversation Practice</h1>

<div id="controls">
    Langue: 
    <select id="language">
        <option value="fr" selected>FranÃ§ais</option>
        <option value="en">English</option>
    </select>
    Niveau: 
    <select id="level">
        <option value="A1">A1</option>
        <option value="A2" selected>A2</option>
        <option value="B1">B1</option>
        <option value="B2">B2</option>
    </select>
    <button id="start-btn">DÃ©marrer</button>
    <div id="speed-container">
        Vitesse de parole: <span id="speed-value">1.0</span>
        <input type="range" id="speech-speed" min="0.5" max="1.2" value="1" step="0.05">
    </div>
</div>

<div id="chat"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Tapez votre phrase ici..." />
    <button id="send-btn">Envoyer</button>
    <button id="speak-btn">ðŸŽ¤ Parler</button>
</div>

<script>
const chatContainer = document.getElementById('chat');
const inputField = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');
const startButton = document.getElementById('start-btn');
const levelSelector = document.getElementById('level');
const speakButton = document.getElementById('speak-btn');
const languageSelector = document.getElementById('language');
const speedSlider = document.getElementById('speech-speed');
const speedValue = document.getElementById('speed-value');

// -------------------- Speech queue --------------------
let speaking = false;
const speechQueue = [];

// Restore last speed from localStorage
let speechRate = parseFloat(localStorage.getItem('speechRate')) || parseFloat(speedSlider.value);
speedSlider.value = speechRate;
speedValue.textContent = speechRate.toFixed(2);

// Update rate from slider
speedSlider.addEventListener('input', () => {
    speechRate = parseFloat(speedSlider.value);
    speedValue.textContent = speechRate.toFixed(2);
    localStorage.setItem('speechRate', speechRate);
});

// -------------------- TTS speak function --------------------
let voices = [];
speechSynthesis.onvoiceschanged = () => {
    voices = speechSynthesis.getVoices();
    console.log(voices);
};

function speak(text) {
    if (!('speechSynthesis' in window) || !text) return;
    speechQueue.push(text);
    if (speaking) return;

    function next() {
        if (speechQueue.length === 0) {
            speaking = false;
            return;
        }
        speaking = true;
        const utter = new SpeechSynthesisUtterance(speechQueue.shift());

        // Select voice based on language
        const langCode = languageSelector.value === 'fr' ? 'fr-FR' : 'en-CA';
        let selectedVoice = voices.find(v => v.lang === langCode);

        // fallback if Canadian English not found
        if (!selectedVoice) {
            selectedVoice = voices.find(v => v.lang.startsWith(languageSelector.value === 'fr' ? 'fr' : 'en'));
        }

        if (selectedVoice) utter.voice = selectedVoice;
        utter.lang = selectedVoice?.lang || langCode;
        utter.rate = speechRate;
        utter.onend = next;
        speechSynthesis.speak(utter);
    }

    next();
}

// -------------------- Append message --------------------
function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = role;
    div.innerHTML = text;

    if (role === 'assistant') {
        const speakBtn = document.createElement('button');
        speakBtn.textContent = 'ðŸ”Š';
        speakBtn.style.marginLeft = '5px';
        speakBtn.addEventListener('click', () => speak(text));
        div.appendChild(speakBtn);
    }

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// -------------------- Start session --------------------
async function startSession(level, language) {
    setupRecognition(language); // Initialize speech recognition for selected language

    const res = await fetch('api/start_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'level=' + encodeURIComponent(level) + '&language=' + encodeURIComponent(language)
    });
    const data = await res.json();
    chatContainer.innerHTML = '';

    if (data.scenario) appendMessage('suggestion', `<em>ScÃ©nario: ${data.scenario}</em>`);
    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }
}

// -------------------- Send user message --------------------
async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    appendMessage('user', text);
    inputField.value = '';

    sendButton.disabled = true;
    speakButton.disabled = true;

    const language = languageSelector.value;

    const res = await fetch('api/continue_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'text=' + encodeURIComponent(text) + '&language=' + encodeURIComponent(language)
    });

    const data = await res.json();

    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }

    if (data.suggestion) appendMessage('suggestion', `<em>${data.suggestion}</em>`);

    sendButton.disabled = false;
    speakButton.disabled = false;
}

// -------------------- Event listeners --------------------
sendButton.addEventListener('click', sendMessage);
inputField.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });
startButton.addEventListener('click', () => startSession(levelSelector.value, languageSelector.value));

// -------------------- Speech recognition --------------------
let recognition;
function setupRecognition(language) {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = language === 'fr' ? 'fr-FR' : 'en-US'; // recognition still en-US if en-CA unavailable
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            inputField.value = transcript;
            sendMessage();
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
        };
    } else {
        speakButton.disabled = true;
        console.warn('Speech recognition not supported in this browser');
    }
}

speakButton.addEventListener('click', () => {
    if (recognition) recognition.start();
});
</script>

</body>
</html>
