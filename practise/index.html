<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>French Conversation Practice</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
#controls { margin-bottom: 10px; }
#chat { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.user { text-align: right; color: blue; margin: 5px; }
.assistant { text-align: left; color: green; margin: 5px; }
.suggestion { text-align: left; color: gray; font-style: italic; margin: 3px; }
input[type=text] { flex: 1; padding: 5px; font-size: 1em; }
button { padding: 5px 10px; font-size: 1em; margin-left: 5px; }
#input-area { display: flex; }
</style>
</head>
<body>

<h1>French Conversation Practice</h1>

<div id="controls">
    Niveau: 
    <select id="level">
        <option value="A1">A1</option>
        <option value="A2" selected>A2</option>
        <option value="B1">B1</option>
        <option value="B2">B2</option>
    </select>
    <button id="start-btn">DÃ©marrer</button>
</div>

<div id="chat"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Tapez votre phrase ici..." />
    <button id="send-btn">Envoyer</button>
    <button id="speak-btn">ðŸŽ¤ Parler</button>
</div>

<script>
const chatContainer = document.getElementById('chat');
const inputField = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');
const startButton = document.getElementById('start-btn');
const levelSelector = document.getElementById('level');
const speakButton = document.getElementById('speak-btn');

function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = role; // 'user', 'assistant', 'suggestion'
    div.innerHTML = text;

    if(role === 'assistant') {
        const speakBtn = document.createElement('button');
        speakBtn.textContent = 'ðŸ”Š';
        speakBtn.style.marginLeft = '5px';
        speakBtn.addEventListener('click', () => speak(text));
        div.appendChild(speakBtn);
    }

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function speak(text) {
    if ('speechSynthesis' in window && text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'fr-FR';
        speechSynthesis.speak(utter);
    }
}

// Start session
async function startSession(level) {
    const res = await fetch('api/start_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'level=' + encodeURIComponent(level)
    });
    const data = await res.json();
    chatContainer.innerHTML = '';

    if (data.scenario) {
        appendMessage('suggestion', `<em>ScÃ©nario: ${data.scenario}</em>`);
    }
    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }
}

// Send user message
async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    appendMessage('user', text);
    inputField.value = '';

    const res = await fetch('api/continue_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'text=' + encodeURIComponent(text)
    });

    const data = await res.json();

    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }

    if (data.suggestion) {
        appendMessage('suggestion', `<em>${data.suggestion}</em>`);
    }
}

// Event listeners
sendButton.addEventListener('click', sendMessage);
inputField.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});
startButton.addEventListener('click', () => startSession(levelSelector.value));

// ðŸŽ¤ Learner speech recognition
let recognition;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        inputField.value = transcript;
        sendMessage(); // automatically send after speaking
    };

    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
    };
} else {
    speakButton.disabled = true;
    console.warn('Speech recognition not supported in this browser');
}

speakButton.addEventListener('click', () => {
    if (recognition) recognition.start();
});
</script>

</body>
</html>
