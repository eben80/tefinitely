<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Language Conversation Practice</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
#controls { margin-bottom: 10px; }
#chat { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.user { text-align: right; color: blue; margin: 5px; }
.assistant { text-align: left; color: green; margin: 5px; }
.suggestion { text-align: left; color: gray; font-style: italic; margin: 3px; }
input[type=text] { flex: 1; padding: 5px; font-size: 1em; }
button { padding: 5px 10px; font-size: 1em; margin-left: 5px; }
#input-area { display: flex; }
#speed-container { margin-top: 5px; }
</style>
</head>
<body>

<h1 id="page-title">Language Conversation Practice</h1>

<div id="controls">
    <label id="lang-label">Langue:</label> 
    <select id="language">
        <option value="fr" selected>FranÃ§ais</option>
        <option value="en">English</option>
    </select>
    <label id="level-label">Niveau:</label> 
    <select id="level"></select>
    <button id="start-btn">DÃ©marrer</button>
    <div id="speed-container">
        <span id="speed-label">Vitesse de parole:</span> 
        <span id="speed-value">1.0</span>
        <input type="range" id="speech-speed" min="0.5" max="1.2" value="1" step="0.05">
    </div>
</div>

<div id="chat"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Tapez votre phrase ici..." />
    <button id="send-btn">Envoyer</button>
    <button id="speak-btn">ðŸŽ¤ Parler</button>
</div>

<script>
const chatContainer = document.getElementById('chat');
const inputField = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');
const startButton = document.getElementById('start-btn');
const levelSelector = document.getElementById('level');
const speakButton = document.getElementById('speak-btn');
const languageSelector = document.getElementById('language');
const speedSlider = document.getElementById('speech-speed');
const speedValue = document.getElementById('speed-value');

// iOS detection
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
let ttsUnlocked = false;

// Interface elements
const pageTitle = document.getElementById('page-title');
const langLabel = document.getElementById('lang-label');
const levelLabel = document.getElementById('level-label');
const speedLabel = document.getElementById('speed-label');

// -------------------- Translations --------------------
const translations = {
    fr: {
        pageTitle: 'Pratique de conversation',
        langLabel: 'Langue:',
        levelLabel: 'Niveau:',
        startBtn: 'DÃ©marrer',
        speedLabel: 'Vitesse de parole:',
        userPlaceholder: 'Tapez votre phrase ici...',
        sendBtn: 'Envoyer',
        speakBtn: 'ðŸŽ¤ Parler',
        levels: {
            A1: 'A1 - DÃ©butant',
            A2: 'A2 - Ã‰lÃ©mentaire',
            B1: 'B1 - IntermÃ©diaire',
            B2: 'B2 - IntermÃ©diaire supÃ©rieur',
            C1: 'C1 - AvancÃ©',
            C2: 'C2 - MaÃ®trise'
        }
    },
    en: {
        pageTitle: 'Conversation Practice',
        langLabel: 'Language:',
        levelLabel: 'Level:',
        startBtn: 'Start',
        speedLabel: 'Speech speed:',
        userPlaceholder: 'Type your sentence here...',
        sendBtn: 'Send',
        speakBtn: 'ðŸŽ¤ Speak',
        levels: {
            A1: 'A1 - Beginner',
            A2: 'A2 - Elementary',
            B1: 'B1 - Intermediate',
            B2: 'B2 - Upper Intermediate',
            C1: 'C1 - Advanced',
            C2: 'C2 - Proficient'
        }
    }
};

// -------------------- UI update --------------------
function updateInterface(lang) {
    const t = translations[lang];
    pageTitle.textContent = t.pageTitle;
    langLabel.textContent = t.langLabel;
    levelLabel.textContent = t.levelLabel;
    startButton.textContent = t.startBtn;
    speedLabel.textContent = t.speedLabel;
    inputField.placeholder = t.userPlaceholder;
    sendButton.textContent = t.sendBtn;
    speakButton.textContent = t.speakBtn;

    levelSelector.innerHTML = '';
    for (const [key, label] of Object.entries(t.levels)) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = label;
        if (key === 'A2') opt.selected = true;
        levelSelector.appendChild(opt);
    }
}

languageSelector.addEventListener('change', () => {
    updateInterface(languageSelector.value);
});

updateInterface(languageSelector.value);

// -------------------- Speech queue --------------------
let speaking = false;
const speechQueue = [];

let speechRate = parseFloat(localStorage.getItem('speechRate')) || parseFloat(speedSlider.value);
speedSlider.value = speechRate;
speedValue.textContent = speechRate.toFixed(2);

speedSlider.addEventListener('input', () => {
    speechRate = parseFloat(speedSlider.value);
    speedValue.textContent = speechRate.toFixed(2);
    localStorage.setItem('speechRate', speechRate);
});

// -------------------- TTS --------------------
let voices = [];

function loadVoices() {
    voices = speechSynthesis.getVoices();
}

speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 500);

function unlockTTS() {
    if (!isIOS || ttsUnlocked || !('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(' ');
    u.volume = 0;
    speechSynthesis.speak(u);
    ttsUnlocked = true;
}

function speak(text) {
    if (!('speechSynthesis' in window) || !text) return;

    if (isIOS) {
        unlockTTS();
        speechSynthesis.cancel();
    }

    speechQueue.push(text);
    if (speaking) return;

    function next() {
        if (speechQueue.length === 0) { speaking = false; return; }

        speaking = true;
        const utter = new SpeechSynthesisUtterance(speechQueue.shift());

        if (languageSelector.value === 'fr') {
            utter.lang = 'fr-FR';
            utter.voice = voices.find(v => v.lang.startsWith('fr')) || null;
        } else {
            utter.lang = 'en-US';
            utter.voice =
                voices.find(v => v.name === 'Google US English') ||
                voices.find(v => v.lang.startsWith('en')) ||
                null;
        }

        utter.rate = speechRate;
        utter.onend = next;
        speechSynthesis.speak(utter);
    }

    next();
}

// -------------------- Append message --------------------
function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = role;
    div.innerHTML = text;

    if (role === 'assistant') {
        const speakBtn = document.createElement('button');
        speakBtn.textContent = 'ðŸ”Š';
        speakBtn.style.marginLeft = '5px';
        speakBtn.addEventListener('click', () => {
            unlockTTS();
            speak(text);
        });
        div.appendChild(speakBtn);
    }

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// -------------------- Start session --------------------
async function startSession(level, language) {
    setupRecognition(language);
    unlockTTS();

    const res = await fetch('api/start_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'level=' + encodeURIComponent(level) + '&language=' + encodeURIComponent(language)
    });
    const data = await res.json();
    chatContainer.innerHTML = '';

    if (data.scenario) appendMessage('suggestion', `<em>ScÃ©nario: ${data.scenario}</em>`);
    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }
}

// -------------------- Send user message --------------------
async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    appendMessage('user', text);
    inputField.value = '';

    sendButton.disabled = true;
    speakButton.disabled = true;
    unlockTTS();

    const res = await fetch('api/continue_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'text=' + encodeURIComponent(text) + '&language=' + encodeURIComponent(languageSelector.value)
    });

    const data = await res.json();

    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }
    if (data.suggestion) appendMessage('suggestion', `<em>${data.suggestion}</em>`);

    sendButton.disabled = false;
    speakButton.disabled = false;
}

// -------------------- Events --------------------
sendButton.addEventListener('click', () => { unlockTTS(); sendMessage(); });
inputField.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });
startButton.addEventListener('click', () => startSession(levelSelector.value, languageSelector.value));

// -------------------- Speech recognition --------------------
let recognition;
function setupRecognition(language) {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = language === 'fr' ? 'fr-FR' : 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = function(event) {
            inputField.value = event.results[0][0].transcript;
            sendMessage();
        };
    }
}

speakButton.addEventListener('click', () => {
    unlockTTS();
    if (recognition) recognition.start();
});
</script>

</body>
</html>
