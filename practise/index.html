<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>French Speaking Practice</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 800px;
  margin: auto;
}

#chat div {
  margin: 10px 0;
}

.assistant {
  color: #1e40af;
}

.user {
  color: #166534;
}

button {
  margin: 5px;
}
  .suggestion {
  color: #6b7280;
  font-size: 0.9em;
  margin-left: 10px;
}
</style>
</head>
<body>

<h2>French Speaking Practice</h2>

<label>Niveau:</label>
<select id="level">
  <option value="A1">A1</option>
  <option value="A2">A2</option>
  <option value="B1">B1</option>
</select>

<button onclick="startSession()">Start</button>

<hr>

<div id="scenario"></div>
<div id="chat"></div>

<hr>

<input id="textInput" placeholder="Votre rÃ©ponse..." style="width:70%">
<button onclick="sendText()">Send</button>
<button onclick="startSpeech()">ðŸŽ¤ Speak</button>

<script>
/* -----------------------
   Speech recognition
------------------------ */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition = null;
if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    send(text);
  };
}

/* -----------------------
   Speech synthesis
------------------------ */
function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'fr-FR';
  speechSynthesis.speak(utterance);
}

/* -----------------------
   Session start
------------------------ */
async function startSession() {
  const level = document.getElementById('level').value;

  const res = await fetch('api/start_session.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'level=' + level
  });

  const data = await res.json();

  document.getElementById('scenario').innerHTML =
    `<strong>Scenario:</strong> ${data.scenario}`;

  document.getElementById('chat').innerHTML =
    `<div class="assistant">${data.assistant}</div>`;

  speak(data.assistant);
}

/* -----------------------
   Send user input
------------------------ */
function sendText() {
  const text = document.getElementById('textInput').value;
  if (!text) return;
  send(text);
  document.getElementById('textInput').value = '';
}

function startSpeech() {
  if (!recognition) {
    alert("Speech recognition not supported in this browser.");
    return;
  }
  recognition.start();
}

async function send(text) {
  document.getElementById('chat').innerHTML +=
    `<div class="user">${text}</div>`;

  const res = await fetch('api/continue_session.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'text=' + encodeURIComponent(text)
  });

  const data = await res.json();

  document.getElementById('chat').innerHTML +=
    `<div class="assistant">${data.assistant}</div>`;

// document.getElementById('chat').innerHTML +=
//   `<div class="assistant">${data.assistant}</div>`;

if (data.suggestion) {
  document.getElementById('chat').innerHTML +=
    `<div class="suggestion"><em>Suggestion: ${data.suggestion}</em></div>`;
}

// Speak ONLY dialogue
speak(data.assistant);
}
</script>

</body>
</html>
