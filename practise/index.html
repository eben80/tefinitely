<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>French Conversation Practice</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
#chat { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
.user { text-align: right; color: blue; margin: 5px; }
.assistant { text-align: left; color: green; margin: 5px; }
.suggestion { text-align: left; color: gray; font-style: italic; margin: 3px; }
#input-area { display: flex; }
#user-input { flex: 1; padding: 5px; font-size: 1em; }
#send-btn { padding: 5px 10px; font-size: 1em; }
</style>
</head>
<body>

<h1>French Conversation Practice</h1>

<div id="chat"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Tapez votre phrase ici..." autofocus />
    <button id="send-btn">Envoyer</button>
</div>

<script>
const chatContainer = document.getElementById('chat');
const inputField = document.getElementById('user-input');
const sendButton = document.getElementById('send-btn');

function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = role; // 'user', 'assistant', 'suggestion'
    div.innerHTML = text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function speak(text) {
    if ('speechSynthesis' in window && text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'fr-FR';
        speechSynthesis.speak(utter);
    }
}

async function startSession(level = 'A2') {
    // Call start_session.php to get scenario and first assistant line
    const res = await fetch('api/start_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'level=' + encodeURIComponent(level)
    });
    const data = await res.json();
    if (data.scenario) {
        appendMessage('suggestion', `<em>Sc√©nario: ${data.scenario}</em>`);
    }
    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }
}

async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    appendMessage('user', text);
    inputField.value = '';

    const res = await fetch('api/continue_session.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'text=' + encodeURIComponent(text)
    });

    const data = await res.json();

    if (data.assistant) {
        appendMessage('assistant', data.assistant);
        speak(data.assistant);
    }

    if (data.suggestion) {
        appendMessage('suggestion', `<em>${data.suggestion}</em>`);
    }
}

// Send on button click
sendButton.addEventListener('click', sendMessage);

// Send on Enter key
inputField.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

// Start session automatically on page load
startSession('A2');
</script>

</body>
</html>
